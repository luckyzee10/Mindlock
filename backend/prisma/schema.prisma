generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PurchaseStatus {
  pending_validation
  completed
  failed
}

model User {
  id        String    @id @default(cuid())
  email     String?   @unique
  createdAt DateTime  @default(now())
  purchases Purchase[]
}

model Charity {
  id          String   @id
  name        String
  description String
  isActive    Boolean  @default(true)
  purchases   Purchase[]
  donations   CharityDonation[]
}

model Purchase {
  id                 String         @id @default(cuid())
  userId             String
  charityId          String
  productId          String
  appleTransactionId String?        @unique
  receiptData        String?
  transactionJws     String
  status             PurchaseStatus @default(pending_validation)
  grossCents         Int
  appleFeeCents      Int
  netCents           Int
  donationCents      Int
  createdAt          DateTime       @default(now())
  completedAt        DateTime?
  failureReason      String?

  user    User    @relation(fields: [userId], references: [id])
  charity Charity @relation(fields: [charityId], references: [id])
  donation CharityDonation?
}

model CharityDonation {
  id            String   @id @default(cuid())
  charityId     String
  purchaseId    String   @unique
  donationCents Int
  recordedAt    DateTime @default(now())

  charity  Charity  @relation(fields: [charityId], references: [id])
  purchase Purchase @relation(fields: [purchaseId], references: [id])
}

model MonthlyReport {
  id          String   @id @default(cuid())
  month       String   @unique
  generatedAt DateTime @default(now())
  payload     Json
}
